<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>增强版网页节拍器</title>
    <style>
        /* 原有样式保持不变，新增以下样式 */
        .advanced-controls {
            margin-top: 20px;
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 15px;
        }

        .control-group {
            background-color: #f8f8f8;
            padding: 15px;
            border-radius: 8px;
            text-align: left;
        }

        .control-group label {
            display: block;
            margin: 5px 0;
            color: #666;
        }

        input[type="number"] {
            width: 100%;
            padding: 8px;
            margin: 5px 0;
            border: 1px solid #ddd;
            border-radius: 4px;
        }

        .status {
            margin-top: 10px;
            font-size: 14px;
            color: #666;
        }
</style>
</head>
<body>
    <!-- 原有HTML结构保持不变，在预设按钮下方添加： -->
    <div class="container">
        <!-- ... 原有内容保持不变 ... -->
        
        <div class="advanced-controls">
            <div class="control-group">
                <h3>定时设置</h3>
                <label>
                    持续时间（分钟）:
                    <input type="number" id="duration" min="1" value="5">
                </label>
                <label>
                    <input type="checkbox" id="enableTimer"> 启用定时
                </label>
            </div>

            <div class="control-group">
                <h3>节拍设置</h3>
                <label>
                    总节拍数:
                    <input type="number" id="totalBeats" min="1" value="60">
                </label>
                <label>
                    <input type="checkbox" id="enableBeatLimit"> 启用节拍数限制
                </label>
            </div>
        </div>

        <div class="status" id="status"></div>
    </div>

    <script>
        // 新增变量
        let beatCount = 0;
        let startTime = 0;
        let totalBeats = 0;
        let duration = 0;
        let beatLimitEnabled = false;
        let timerEnabled = false;

        // 修改后的startMetronome函数
        function startMetronome() {
            if (!isPlaying) {
                // 重置计数器
                beatCount = 0;
                startTime = Date.now();
                totalBeats = parseInt(document.getElementById('totalBeats').value);
                duration = parseInt(document.getElementById('duration').value) * 60 * 1000;
                beatLimitEnabled = document.getElementById('enableBeatLimit').checked;
                timerEnabled = document.getElementById('enableTimer').checked;

                const bpm = parseInt(bpmInput.value);
                const interval = 60000 / bpm;
                
                timerId = setInterval(() => {
                    // 检查停止条件
                    if (shouldStop()) {
                        stopMetronome();
                        return;
                    }

                    playClick();
                    updateVisual();
                    beatCount++;
                    updateStatus();
                }, interval);
                
                isPlaying = true;
                startStopButton.textContent = '停止';
                updateStatus();
            } else {
                stopMetronome();
            }
        }

        // 新增停止条件判断
        function shouldStop() {
            // 检查节拍数限制
            if (beatLimitEnabled && beatCount >= totalBeats) return true;
            
            // 检查定时限制
            if (timerEnabled && (Date.now() - startTime) >= duration) return true;
            
            return false;
        }

        // 新增停止函数
        function stopMetronome() {
            clearInterval(timerId);
            isPlaying = false;
            startStopButton.textContent = '开始';
            updateStatus(true);
        }

        // 新增状态更新函数
        function updateStatus(stopped = false) {
            const statusElement = document.getElementById('status');
            if (!isPlaying) {
                statusElement.textContent = stopped ? '已停止' : '准备就绪';
                return;
            }

            let statusText = [];
            
            if (timerEnabled) {
                const elapsed = Date.now() - startTime;
                const remaining = duration - elapsed;
                const minutes = Math.floor(remaining / 60000);
                const seconds = Math.floor((remaining % 60000) / 1000);
                statusText.push(`剩余时间: ${minutes}:${seconds.toString().padStart(2, '0')}`);
            }

            if (beatLimitEnabled) {
                statusText.push(`剩余节拍: ${totalBeats - beatCount}`);
            }

            statusElement.textContent = statusText.join(' | ');
        }

        // 新增事件监听（在原有事件监听之后添加）
        document.getElementById('enableTimer').addEventListener('change', function() {
            document.getElementById('duration').disabled = !this.checked;
        });

        document.getElementById('enableBeatLimit').addEventListener('change', function() {
            document.getElementById('totalBeats').disabled = !this.checked;
        });

        // 初始化禁用状态
        document.getElementById('duration').disabled = true;
        document.getElementById('totalBeats').disabled = true;
    </script>
</body>
</html>
